<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ICS Calendar Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
      max-width: 1200px;
      margin: auto;
    }

    input[type="file"],
    input[type="date"] {
      margin-right: 1em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 0.5em;
      font-size: 0.9em;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
      cursor: pointer;
    }

    button {
      margin-top: 1em;
      padding: 0.6em 1.2em;
      font-size: 1em;
      cursor: pointer;
    }

    .controls {
      margin-bottom: 1em;
    }

    .row-details {
      /* Initially shown, toggled by checkbox */
    }
  </style>
</head>

<body>
  <h1>ICS Calendar Parser</h1>

  <div class="controls">
    <label>Upload ICS File: <input type="file" id="icsFile" accept=".ics"></label>
  </div>
  <div class="controls">
    <label>From: <input type="date" id="filterFrom"></label>
    <label>To: <input type="date" id="filterTo"></label>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>
  <div class="controls">
    <label><input type="checkbox" id="toggleHidden"> Show hidden columns</label>
  </div>
  <div class="controls">
    <button id="downloadBtn" style="display: none;">Download CSV</button>
  </div>

  <div id="calendarInfo"></div>
  <div id="output"></div>

  <script>
    let parsedEvents = [];
    let filteredEvents = [];
    let calendarMeta = { name: "", timezone: "" };

    document.getElementById('icsFile').addEventListener('change', handleFile);

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        parseICS(unfoldICS(content));
        setDefaultDateFilters();
        applyFilters();
      };
      reader.readAsText(file);
    }

    function parseICS(data) {
      parsedEvents = [];

      const nameMatch = data.match(/X-WR-CALNAME:(.+)/);
      const tzMatch = data.match(/X-WR-TIMEZONE:(.+)/);
      calendarMeta.name = nameMatch ? nameMatch[1].trim() : "Unknown";
      calendarMeta.timezone = tzMatch ? tzMatch[1].trim() : "UTC";

      const events = data.split("BEGIN:VEVENT");
      events.shift();

      for (const rawEvent of events) {
        const content = rawEvent.split("END:VEVENT")[0];

        const get = (key) => {
          const match = content.match(new RegExp(`${key}(?:;[^\\n]*)?:([^\r\n]+)`));
          return match ? match[1].replace(/\\,/g, ",").replace(/\\n/g, "\n").trim() : "";
        };

        function formatDate(dt) {
          if (!dt) return { formatedDate: "", iso: "", formatedTime: "" };

          let dateObj;
          if (dt.endsWith('Z')) {
            const isoString = dt.replace(/(\d{8}T\d{6})Z/, (_, p1) =>
              `${p1.slice(0, 4)}-${p1.slice(4, 6)}-${p1.slice(6, 8)}T${p1.slice(9, 11)}:${p1.slice(11, 13)}:${p1.slice(13, 15)}Z`
            );
            dateObj = new Date(isoString);
          } else {
            const isoString = dt.replace(/(\d{8}T\d{6})/, (_, p1) =>
              `${p1.slice(0, 4)}-${p1.slice(4, 6)}-${p1.slice(6, 8)}T${p1.slice(9, 11)}:${p1.slice(11, 13)}:${p1.slice(13, 15)}`
            );
            dateObj = new Date(isoString);
          }

          if (isNaN(dateObj)) return { formatedDate: "", iso: "", formatedTime: "" };

          const day = String(dateObj.getDate()).padStart(2, '0');
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const year = dateObj.getFullYear();

          const hours = String(dateObj.getHours()).padStart(2, '0');
          const minutes = String(dateObj.getMinutes()).padStart(2, '0');

          return {
            formatedDate: `${day}-${month}-${year}`,
            iso: dateObj.toISOString().slice(0, 10),
            formatedTime: `${hours}:${minutes}`
          };
        }

        const ev = {
          summary: get("SUMMARY"),
          location: get("LOCATION"),
          startDate: formatDate(get("DTSTART")),
          endDate: formatDate(get("DTEND")),
          uid: get("UID"),
          creationDate: formatDate(get("CREATED")),
          modifyDate: formatDate(get("LAST-MODIFIED")),
          status: get("STATUS"),
          sequence: get("SEQUENCE"),
          transparency: get("TRANSP"),
          rawDescription: get("DESCRIPTION"),
          description: get("DESCRIPTION").replace(/\n/g, "<br>").replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;")
        };

        parsedEvents.push(ev);
      }
    }

    function unfoldICS(text) {
      return text.replace(/\r?\n[ \t]/g, '');
    }

    function applyFilters() {
      const from = document.getElementById("filterFrom").value;
      const to = document.getElementById("filterTo").value;

      filteredEvents = parsedEvents.filter(ev => {
        const eventDate = ev.startDate.iso;
        if (from && eventDate < from) return false;
        if (to && eventDate > to) return false;
        return true;
      });

      renderTable();
    }

    function renderTable() {
      const info = `<h3>Calendar: ${calendarMeta.name}</h3>
      <!--<p>Timezone: ${calendarMeta.timezone}</p>-->
        `;
      document.getElementById("calendarInfo").innerHTML = info;

      if (filteredEvents.length === 0) {
        document.getElementById("output").innerHTML = "<p>No events found.</p>";
        document.getElementById("downloadBtn").style.display = "none";
        return;
      }

      let html = `
      <table id="eventsTable"><thead><tr>
        <th class="row-details" style="min-width: 100px" onclick="sortBy('uid')">UID</th>
        <th style="min-width: 200px" onclick="sortBy('summary')">Summary</th>
        <th style="min-width: 200px" onclick="sortBy('location')">Location</th>
        <th style="min-width: 75px" onclick="sortBy('startDate.formatedDate')">Start Date</th>
        <th style="min-width: 75px" onclick="sortBy('startDate.formatedTime')">Start Time</th>
        <th style="min-width: 75px" onclick="sortBy('endDate.formatedDate')">End Date</th>
        <th style="min-width: 75px" onclick="sortBy('endDate.formatedTime')">End Time</th>
        <th style="min-width: 400px" onclick="sortBy('description')">Description</th>
        <th class="row-details" style="min-width: 100px" onclick="sortBy('status')">Status</th>
        <th class="row-details" style="min-width: 100px" onclick="sortBy('sequence')">Seq</th>
        <th class="row-details" style="min-width: 100px" onclick="sortBy('transparency')">Transparency</th>
        <th class="row-details" style="min-width: 100px" onclick="sortBy('creationDate.formatedDate')">Created</th>
        <th class="row-details" style="min-width: 100px" onclick="sortBy('modifyDate.formatedDate')">Modified</th>
      </tr></thead><tbody>`;

      filteredEvents.forEach(ev => {
        html += `<tr>
          <td class="row-details">${ev.uid}</td>
          <td>${ev.summary}</td>
          <td>${ev.location}</td>
          <td>${ev.startDate.formatedDate}</td><td>${ev.startDate.formatedTime}</td>
          <td>${ev.endDate.formatedDate}</td><td>${ev.endDate.formatedTime}</td>
          <td>${ev.description}</td>
          <td class="row-details">${ev.status}</td>
          <td class="row-details">${ev.sequence}</td>
          <td class="row-details">${ev.transparency}</td>
          <td class="row-details">${ev.creationDate.formatedDate}</td>
          <td class="row-details">${ev.modifyDate.formatedDate}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById("output").innerHTML = html;
      document.getElementById("downloadBtn").style.display = "inline-block";

      // Apply hidden columns toggle
      const toggle = document.getElementById("toggleHidden");
      const show = toggle.checked;
      document.querySelectorAll(".row-details").forEach(el => {
        el.style.display = show ? "" : "none";
      });
    }

    function sortBy(field) {
      const keys = field.split(".");
      filteredEvents.sort((a, b) => {
        const valA = keys.reduce((obj, key) => obj?.[key] || "", a);
        const valB = keys.reduce((obj, key) => obj?.[key] || "", b);
        return valA.localeCompare(valB);
      });
      renderTable();
    }

    function toLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function setDefaultDateFilters() {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      document.getElementById("filterFrom").value = toLocalDateString(firstDay);
      document.getElementById("filterTo").value = toLocalDateString(lastDay);
    }

    document.getElementById("toggleHidden").addEventListener("change", function () {
      const show = this.checked;
      document.querySelectorAll(".row-details").forEach(el => {
        el.style.display = show ? "" : "none";
      });
    });

    function downloadCSV() {
      const headers = [
        "UID",
        "Summary",
        "Location",
        "Start Date", "Start Time",
        "End Date", "End Time",
        "Description",
        //"Status", "Sequence", "Transparency",
        "Created Date", "Modified Date"
      ];

      function escapeCSV(text) {
        if (text == null) return '""';
        // Replace all " with ""
        let escaped = text.replace(/"/g, '""');
        return `"${escaped}"`;
      }


      const rows = [headers, ...filteredEvents.map(ev => [
        escapeCSV(ev.uid),
        escapeCSV(ev.summary),
        escapeCSV(ev.location),
        ev.startDate.formatedDate,
        ev.startDate.formatedTime,
        ev.endDate.formatedDate,
        ev.endDate.formatedTime,
        escapeCSV(ev.rawDescription),
        //escapeCSV(ev.status),
        //escapeCSV(ev.sequence),
        //escapeCSV(ev.transparency),
        ev.creationDate.formatedDate,
        ev.modifyDate.formatedDate
      ])];

      const csvContent = rows.map(e => e.join(";")).join("\n");
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "calendar_events.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("downloadBtn").addEventListener("click", downloadCSV);
  </script>
</body>

</html>